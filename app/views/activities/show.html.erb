<div class="container mt-5 mb-5">
  <div class="card shadow-lg p-4 w-100" style="max-width: 900px; margin: 0 auto;">
    <div class="card-body">
      <h1 class="text-center mb-4"><%= @activity.title %></h1>
      
      <div class="mb-4">
        <p><strong><%= t('activities.description') %>:</strong> <%= @activity.description %></p>
        <p><strong><%= t('activities.level') %>:</strong> <span class="badge <%= @activity.level_color_class %>"><%= @activity.level %></span></p>
        <p><strong><%= t('activities.total_questions') %>:</strong> <%= @activity.questions.count %></p>
        
        <% if @activity.statement.present? %>
          <div class="card bg-light mb-3">
            <div class="card-body">
              <%= simple_format(@activity.statement) %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Exibição da mídia -->
      <% if @activity.media_url.present? %>
        <div class="mb-4">
          <% if @activity.media_url.include?('youtube.com') || @activity.media_url.include?('youtu.be') %>
            <% youtube_id = @activity.media_url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/) %>
            <% if youtube_id && youtube_id[1] %>
              <div class="ratio ratio-16x9 mb-3">
                <iframe 
                  src="https://www.youtube.com/embed/<%= youtube_id[1] %>" 
                  allowfullscreen
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
                </iframe>
              </div>
            <% end %>
          <% else %>
            <img src="<%= @activity.media_url %>" alt="Imagem da atividade" class="img-fluid mb-3">
          <% end %>
        </div>
      <% end %>

      <!-- Exibição do texto explicativo -->
      <% if @activity.explanation_text.present? %>
        <div class="mb-4">
          <div class="card">
            <div class="card-body">
              <%= simple_format(@activity.explanation_text) %>
            </div>
          </div>
        </div>
      <% end %>

      <% if current_user.teacher? %>
        <!-- Visualização do Professor -->
        <div id="questions-list" class="mb-4">
          <% if @activity.questions.any? %>
            <div class="list-group">
              <% @activity.questions.each_with_index do |question, index| %>
                <div class="list-group-item">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h5 class="mb-1"><%= t('questions.title') %> <%= index + 1 %></h5>
                      <p class="mb-1"><%= question.content %></p>
                      <% if question.options.any? %>
                        <small class="text-muted"><%= t('questions.options') %>:</small>
                        <ul class="mb-1">
                          <% question.options.each do |option| %>
                            <li><%= option %></li>
                          <% end %>
                        </ul>
                        <small class="text-success"><%= t('questions.correct_answer') %>: <%= question.correct_answer %></small>
                      <% end %>
                    </div>
                    <% if @activity.teacher == current_user %>
                      <div class="btn-group">
                        <%= link_to t('common.edit'), edit_activity_question_path(@activity, question), class: "btn btn-warning btn-sm" %>
                        <%= button_to t('common.delete'), activity_question_path(@activity, question), 
                            method: :delete, 
                            class: "btn btn-danger btn-sm",
                            data: { confirm: t('questions.confirm_delete') } %>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="alert alert-warning">
              <p class="mb-0"><%= t('activities.no_questions') %></p>
            </div>
          <% end %>
        </div>

        <!-- Botões de Ação do Professor -->
        <div class="d-grid gap-2">
          <!-- Botão para adicionar enunciado -->
          <button type="button" class="btn btn-success" data-bs-toggle="collapse" data-bs-target="#new-statement-form">
            <%= t('activities.add_statement') %>
          </button>
          
          <div class="collapse" id="new-statement-form">
            <div class="card card-body mt-3 mb-3">
              <%= form_with(model: @activity, local: true, data: { turbo: false }) do |f| %>
                <div class="mb-3">
                  <%= f.label :statement, t('activities.statement_label'), class: "form-label" %>
                  <%= f.text_area :statement, class: "form-control", rows: 5,
                      placeholder: t('activities.statement_placeholder') %>
                </div>
                <div class="d-grid">
                  <%= f.submit t('activities.save_statement'), class: "btn btn-primary" %>
                </div>
              <% end %>
            </div>
          </div>

          <!-- Botão para adicionar mídia -->
          <button type="button" class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#new-media-form">
            <%= t('activities.add_media') %>
          </button>
          
          <div class="collapse" id="new-media-form">
            <div class="card card-body mt-3 mb-3">
              <%= form_with(model: @activity, local: true, data: { turbo: false }) do |f| %>
                <div class="mb-3">
                  <%= f.label :media_url, t('activities.media_url_label'), class: "form-label" %>
                  <%= f.text_field :media_url, class: "form-control", 
                      placeholder: t('activities.media_url_placeholder') %>
                  <div class="form-text"><%= t('activities.media_url_help') %></div>
                </div>
                <div class="d-grid">
                  <%= f.submit t('activities.save_media'), class: "btn btn-primary" %>
                </div>
              <% end %>
            </div>
          </div>
          
          <!-- Botão para adicionar texto explicativo -->
          <button type="button" class="btn btn-info" data-bs-toggle="collapse" data-bs-target="#new-text-form">
            <%= t('activities.add_text') %>
          </button>
          
          <div class="collapse" id="new-text-form">
            <div class="card card-body mt-3 mb-3">
              <%= form_with(model: @activity, local: true, data: { turbo: false }) do |f| %>
                <div class="mb-3">
                  <%= f.label :explanation_text, t('activities.explanation_text_label'), class: "form-label" %>
                  <%= f.text_area :explanation_text, class: "form-control", rows: 5,
                      placeholder: t('activities.explanation_text_placeholder') %>
                </div>
                <div class="d-grid">
                  <%= f.submit t('activities.save_text'), class: "btn btn-primary" %>
                </div>
              <% end %>
            </div>
          </div>

          <button type="button" class="btn btn-warning" data-bs-toggle="collapse" data-bs-target="#new-question-form">
            <%= t('activities.add_question') %>
          </button>
          
          <div class="collapse" id="new-question-form">
            <div class="card card-body mt-3 mb-3">
              <%= render partial: "questions/form", locals: { question: @activity.questions.build, activity: @activity } %>
            </div>
          </div>

          <div class="btn-group w-100">
            <%= link_to t('activities.edit_btn'), edit_activity_path(@activity), class: "btn btn-warning" %>
            <%= link_to t('activities.delete'), 
                activity_path(@activity), 
                class: "btn btn-danger",
                data: {
                  turbo_method: :delete,
                  turbo_confirm: t('activities.confirm_delete')
                } %>
          </div>
          
          <%= link_to t('activities.solve_quiz'), resolve_quiz_activity_path(@activity), class: "btn btn-success mt-2" %>
        </div>
      <% else %>
        <!-- Visualização do Aluno -->
        <div class="d-grid gap-2">
          <%= link_to t('activities.solve_quiz'), resolve_quiz_activity_path(@activity), class: "btn btn-success" %>
        </div>
      <% end %>

      <!-- Botão Voltar -->
      <div class="d-grid mt-4">
        <% if current_user.teacher? %>
          <%= link_to t('activities.back_to_dashboard'), teacher_dashboard_path, class: "btn btn-secondary" %>
        <% else %>
          <%= link_to t('activities.back_to_dashboard'), student_dashboard_path, class: "btn btn-secondary" %>
        <% end %>
      </div>
    </div>
  </div>
</div>
